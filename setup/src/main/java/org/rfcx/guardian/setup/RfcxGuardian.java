package org.rfcx.guardian.setup;

import java.util.Map;

import org.rfcx.guardian.utility.datetime.DateTimeUtils;
import org.rfcx.guardian.utility.device.DeviceBattery;
import org.rfcx.guardian.utility.device.DeviceConnectivity;
import org.rfcx.guardian.utility.misc.ShellCommands;
import org.rfcx.guardian.utility.rfcx.RfcxDeviceGuid;
import org.rfcx.guardian.utility.rfcx.RfcxLog;
import org.rfcx.guardian.utility.rfcx.RfcxPrefs;
import org.rfcx.guardian.utility.rfcx.RfcxRole;
import org.rfcx.guardian.utility.service.RfcxServiceHandler;

import android.app.Application;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.content.SharedPreferences.OnSharedPreferenceChangeListener;
import android.net.ConnectivityManager;
import android.preference.PreferenceManager;
import android.util.Log;
import org.rfcx.guardian.setup.api.UpdateCheckInUtils;
import org.rfcx.guardian.setup.device.android.control.RebootTriggerJobService;
import org.rfcx.guardian.setup.receiver.ConnectivityReceiver;
import org.rfcx.guardian.setup.service.ApiCheckVersionIntentService;
import org.rfcx.guardian.setup.service.ApiCheckVersionService;
import org.rfcx.guardian.setup.service.ApiRegisterService;
import org.rfcx.guardian.setup.service.ApkDownloadService;
import org.rfcx.guardian.setup.service.ApkInstallService;

public class RfcxGuardian extends Application implements OnSharedPreferenceChangeListener {
	
	public String version;
	Context context;
	
	public static final String APP_ROLE = "Setup";

	private static final String logTag = RfcxLog.generateLogTag(APP_ROLE, RfcxGuardian.class);

	public RfcxDeviceGuid rfcxDeviceGuid = null; 
	public RfcxPrefs rfcxPrefs = null;
	public RfcxServiceHandler rfcxServiceHandler = null;

	public SharedPreferences sharedPrefs = null;
	
	public static final String targetAppRoleApiEndpoint = "all";
	public String targetAppRole = "";
	
	public long lastApiCheckTriggeredAt = System.currentTimeMillis();
	
	private final BroadcastReceiver connectivityReceiver = new ConnectivityReceiver();
	
	public UpdateCheckInUtils apiCore = new UpdateCheckInUtils();
	
	public DeviceBattery deviceBattery = new DeviceBattery(APP_ROLE);
	public DeviceConnectivity deviceConnectivity = new DeviceConnectivity(APP_ROLE);

	public String[] RfcxCoreServices = 
		new String[] { 
		};
	
	@Override
	public void onCreate() {
		
		super.onCreate();

		this.rfcxDeviceGuid = new RfcxDeviceGuid(this, APP_ROLE);
		this.rfcxPrefs = new RfcxPrefs(this, APP_ROLE);
		this.rfcxServiceHandler = new RfcxServiceHandler(this, APP_ROLE);
		
		this.version = RfcxRole.getRoleVersion(this, logTag);
		
		this.registerReceiver(connectivityReceiver, new IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION));
		
		PreferenceManager.setDefaultValues(this, R.xml.prefs, true);
		this.sharedPrefs = PreferenceManager.getDefaultSharedPreferences(this);
		this.sharedPrefs.registerOnSharedPreferenceChangeListener(this);
		this.syncSharedPrefs();
		
		if (this.sharedPrefs.getString("guardian_guid", "").trim().length() != 12) {
			this.setPref("guardian_guid", this.rfcxDeviceGuid.getDeviceGuid());
		}
		
		Log.d(logTag, "Guardian GUID: "+this.getDeviceGuid());
		this.rfcxPrefs.writeGuidToFile(this.getDeviceGuid());
		
		this.apiCore.targetAppRoleApiEndpoint = this.targetAppRoleApiEndpoint;
		this.apiCore.setApiCheckVersionEndpoint(this.getDeviceGuid());
		this.apiCore.setApiRegisterEndpoint();
		
		setDbHandlers();
		setServiceHandlers();
		
		ShellCommands.triggerNeedForRootAccess(this);
		
		initializeRoleServices();

	}
	
	public void onTerminate() {
		super.onTerminate();
		this.unregisterReceiver(connectivityReceiver);
	}
	
	public void appResume() {
		syncSharedPrefs();
	}
	
	public void appPause() {
		
	}
	
	public void initializeRoleServices() {
		
		if (!this.rfcxServiceHandler.hasRun("OnLaunchServiceSequence")) {
			
			String[] onLaunchServices = new String[RfcxCoreServices.length+1];
			System.arraycopy(RfcxCoreServices, 0, onLaunchServices, 0, RfcxCoreServices.length);
			onLaunchServices[RfcxCoreServices.length] = 
					"ApiCheckVersionIntentService"
							+"|"+DateTimeUtils.nowPlusThisLong("00:02:00").getTimeInMillis() // waits 2 minutes before running
							+"|"+3600000 // repeats hourly
						;
			
			this.rfcxServiceHandler.triggerServiceSequence("OnLaunchServiceSequence", onLaunchServices, true, 0);
		}
	}
	
	private void setDbHandlers() {

	}

	private void setServiceHandlers() {
		this.rfcxServiceHandler.addService("ApiCheckVersion", ApiCheckVersionService.class);
		this.rfcxServiceHandler.addService("ApiCheckVersionIntentService", ApiCheckVersionIntentService.class);
		this.rfcxServiceHandler.addService("ApiRegister", ApiRegisterService.class);
		
		this.rfcxServiceHandler.addService("ApkInstall", ApkInstallService.class);
		this.rfcxServiceHandler.addService("ApkDownload", ApkDownloadService.class);
		this.rfcxServiceHandler.addService("RebootTrigger", RebootTriggerJobService.class);		
	}
	
	

	
	@Override
	public synchronized void onSharedPreferenceChanged(SharedPreferences sharedPreferences, String prefKey) {
		Log.d(logTag, "Pref changed: "+prefKey+" = "+this.sharedPrefs.getString(prefKey, null));
		syncSharedPrefs();
	}
	
	private void syncSharedPrefs() {
		for ( Map.Entry<String,?> pref : this.sharedPrefs.getAll().entrySet() ) {
//			this.rfcxPrefs.setPref(pref.getKey(), pref.getValue().toString());
		}
	}
	
	public boolean setPref(String prefKey, String prefValue) {
		return this.sharedPrefs.edit().putString(prefKey,prefValue).commit();
	}
	
	public String getPref(String prefKey) {
		return this.sharedPrefs.getString(prefKey, null);
	}
	
	public String getDeviceGuid() {
		if (this.sharedPrefs.getString("guardian_guid", "").length() == 12) {
			return this.sharedPrefs.getString("guardian_guid", null);
		} else {
			return this.rfcxDeviceGuid.getDeviceGuid();
		}
	}
	
	    
}
